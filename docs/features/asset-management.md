# Управление активами

## Обзор модуля
Страница `src/assets.php` собирает параметры поиска, применяет фильтры к активам выбранного инстанса и подготавливает структуру данных для шаблона `assets.twig`.

## Структура фильтров и пагинации
- **Основные параметры**: каждый запрос фиксирует инстанс, связанный проект и параметры страницы (`page`, `resultsperpage`). Дополнительные настройки управляют видимостью связанных, архивированных активов и миниатюр изображений.【F:src/assets.php†L16-L47】
- **Категории и группы**: категории и группы подключаются через `LEFT JOIN` и, при необходимости, фильтруются с помощью `IN`. Дополнительно формируется список выбранных значений для повторного отображения на клиенте.【F:src/assets.php†L92-L96】【F:src/assets.php†L256-L277】
- **Производители**: активы можно ограничить производителем; их идентификаторы валидируются и обратно подставляются в `SELECTED_TERMS`.【F:src/assets.php†L97-L100】【F:src/assets.php†L265-L269】
- **Ключевые слова и теги**: условия по ключевым словам формируются как OR-группа по производителю, описанию и названию типа. Поиск по тегам выполняется как `LIKE` в основной выборке и подзапросе, чтобы исключить лишние типы до пагинации.【F:src/assets.php†L114-L127】【F:src/assets.php†L151-L163】【F:src/assets.php†L195-L207】
- **Группы**: применяются как `FIND_IN_SET` в подзапросе и основной выборке; значения валидируются и дополняются названиями для UI.【F:src/assets.php†L136-L149】【F:src/assets.php†L180-L193】【F:src/assets.php†L257-L263】
- **Диапазоны дат**: даты можно задать напрямую или автоматически подставить из выбранного проекта; некорректные диапазоны отбрасываются.【F:src/assets.php†L6-L88】
- **Пагинация**: используется `arraybuilder()->paginate`, что возвращает итоговые страницы, общее количество записей и смещение (offset) для текущего листа.【F:src/assets.php†L168-L175】
- **Опции проектов**: список доступных проектов загружается отдельно с учётом статуса и клиента для подстановки в фильтр.【F:src/assets.php†L244-L255】

## Резервирование, связанные активы и настройки отображения
- При наличии дат поиска каждая единица проверяется на пересекающиеся назначения в `assetsAssignments`, включая статусы проектов, чтобы показать активы, уже забронированные или заблокированные флагами.【F:src/assets.php†L218-L234】
- Настройка `SHOWLINKED` исключает или возвращает активы, привязанные к другим позициям, а `SHOWARCHIVED` управляет скрытием архивированных и завершённых единиц в обеих выборках.【F:src/assets.php†L22-L25】【F:src/assets.php†L134-L151】【F:src/assets.php†L178-L195】
- Для каждого типа рассчитываются доступные и заблокированные количества, миниатюры из S3 и массив тегов, что упрощает отображение связанного оборудования и статусов доступности на UI.【F:src/assets.php†L211-L237】

## Сценарии работы
### Поиск оборудования
1. Пользователь задаёт параметры фильтра и пагинации, которые преобразуются в `$SEARCH` и ограничения SQL.【F:src/assets.php†L16-L175】
2. При необходимости выполняется проверка пересечений с конкретным проектом, чтобы сразу увидеть конфликтующие брони.【F:src/assets.php†L59-L88】【F:src/assets.php†L218-L234】
3. Для быстрой точечной проверки можно использовать API `/api/assets/searchAssets.php`, которое ищет по тегам и названиям с опциональной выдачей штрихкодов.【F:src/api/assets/searchAssets.php†L4-L33】

### Массовые изменения
1. Изменения полей экземпляров активов проходят через `/api/assets/editAsset.php`, где значения нормализуются, проверяются на уникальность и применяются к записи.【F:src/api/assets/editAsset.php†L9-L44】
2. После обновления веса, стоимости или ставок пересчитываются связанные проекты через `projectFinanceCacher`, что гарантирует корректность расчётов аренды и скидок.【F:src/api/assets/editAsset.php†L45-L84】
3. Для правок на уровне типа используйте `/api/assets/editAssetType.php`, которое обновляет значения массово и синхронизирует их с каждым активом этого типа и его назначениями.【F:src/api/assets/editAssetType.php†L8-L82】

### Экспорт каталога
1. API `/api/assets/export.php` формирует CSV или XLSX с сортировкой по категориям, типам и тегам, подтягивая веса, ставки, значимые поля и историю сканирований.【F:src/api/assets/export.php†L3-L140】
2. Денежные значения форматируются через `IntlMoneyFormatter`, используя валюту инстанса, чтобы экспорт соответствовал финансовым отчётам.【F:src/api/assets/export.php†L15-L67】

### Работа со связанными API
- **Перемещение между инстансами**: `/api/assets/transfer.php` проверяет права на обеих площадках, при необходимости клонирует тип, производителя и категорию и архивирует оригинал.【F:src/api/assets/transfer.php†L4-L105】
- **Поиск типов** и создание новых единиц доступны в соседних файлах (`searchType.php`, `newAssetFromType.php`), использующих тот же подход к проверкам прав и структуре ответа.

## Лучшие практики
- Используйте фильтры категорий, производителей и групп совместно, чтобы ограничивать выборку до релевантного сегмента и облегчать инвентаризацию; система хранит выбранные значения для UI, поэтому повторные поиски минимальны.【F:src/assets.php†L92-L96】【F:src/assets.php†L256-L277】
- Поддерживайте чистоту тегов и ключевых слов — фильтрация выполняется на уровне SQL до пагинации, что делает поиск чувствительным к опечаткам.【F:src/assets.php†L114-L175】
- Перед изменениями ставок или массы проверяйте открытые брони: перерасчёт выполняется автоматически, но актуальность данных зависит от своевременных обновлений.【F:src/api/assets/editAsset.php†L45-L84】【F:src/api/assets/editAssetType.php†L36-L82】
- При переносе активов между инстансами заранее готовьте соответствующие категории и производителей, чтобы избежать блокировки операции и обеспечить корректный аудит.【F:src/api/assets/transfer.php†L24-L82】【F:src/api/assets/transfer.php†L93-L105】
- Для предотвращения конфликтов по броням проверяйте блокировки и назначения через отчёт `countBlocked`/`countAvailable`, который учитывает статусы проектов и флаги при каждой выборке.【F:src/assets.php†L211-L237】

## Простой пошаговый гайд
1. **Откройте страницу активов.** Выберите инстанс (если их несколько) и убедитесь, что нужный проект подставлен автоматически или выберите его вручную.
2. **Настройте фильтры.** Отметьте категории, производителей, группы или введите ключевые слова. Включите или отключите показ архива и связанных активов, чтобы быстро сфокусироваться на нужных единицах.
3. **Укажите даты аренды.** Если важно проверить доступность, задайте период — система подсветит занятые позиции и укажет, каким проектом они заняты.
4. **Запустите поиск.** Нажмите кнопку фильтрации — таблица обновится, а снизу появятся номера страниц для перехода между результатами.
5. **Изучите карточку.** Нажмите на актив, чтобы посмотреть теги, файлы, историю бронирований и связанные единицы.
6. **Применяйте массовые действия.** Выделите несколько позиций и выберите операцию (изменение цены, статуса, веса) — система отправит изменения через соответствующий API и обновит расчёты проектов.
7. **Выгружайте данные.** Кнопка экспорта сформирует CSV или XLSX со всеми полями, сгруппированными по типам и категориям, — пригодится для отчётности.
8. **Следите за конфликтами.** Перед подтверждением аренды проверьте индикаторы доступности или отчёты `countBlocked`/`countAvailable`, чтобы избежать пересечений по датам.
