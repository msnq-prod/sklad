# Аутентификация и управление токенами

## Архитектура `authTokens`
- Все токены создаются методом `generateToken`, который генерирует 32-символьный ключ, фиксирует тип устройства, IP-адрес и связывает запись с пользователем и (при необходимости) администратором, выполнившим вход «от лица»; токены типов `web-session`, `app-v1` и `app-v2-magic-email` сохраняются в таблице `authTokens` и при необходимости помещаются в сессию.【F:src/common/libs/Auth/main.php†L231-L270】
- При каждом обращении `getToken` ищет JWT в теле запроса (мобильные клиенты) или сессионный токен, декодирует его с использованием `AUTH_JWTKey` и проверяет тип потока; просроченные JWT сразу отклоняются.【F:src/common/libs/Auth/main.php†L26-L43】
- `checkToken` убеждается, что токен существует, не истёк (12 часов с момента создания) и был выдан тому же IP-адресу, в том числе с учётом заголовков `CF-Connecting-IP` и `X-Forwarded-For`; при несоответствии бросается `AuthFail` с пояснением, поэтому основными сценариями ошибок являются: токен не найден, истёкший TTL, несовпадение IP на прямом или прокси-доступе.【F:src/common/libs/Auth/main.php†L49-L75】
- Для мобильных клиентов сервер выпускает JWT с тем же 12-часовым сроком действия, закреплённым за конкретным внутренним токеном и пользователем; полезная нагрузка содержит идентификатор токена, тип и issuer, что позволяет клиентам безопасно хранить данные, не раскрывая сам `authTokens_token`.【F:src/common/libs/Auth/main.php†L282-L294】
- Выход из системы помечает текущий токен как недействительный в базе и очищает серверную сессию, предотвращая повторное использование ключа даже при утечке cookie.【F:src/common/libs/Auth/main.php†L296-L305】

## Основные потоки входа

### Веб-форма входа
- Страница `/login` подготавливает конфигурацию шаблона, проверяет доступность регистрации и провайдеров OAuth и перенаправляет авторизованных пользователей на корневой путь, чтобы избегать циклических редиректов.【F:src/login/index.php†L6-L30】
- Запрос `?logout` вызывает `logout()` и мгновенно возвращает пользователя на главную, а при параметре `app-oauth` сбрасывает состояние возврата и инициирует вход для мобильного OAuth-клиента.【F:src/login/index.php†L12-L25】

### Магические ссылки
- Если передан параметр `app-magiclink`, контроллер проверяет его по списку допустимых URI (или разрешает в DEV), пробрасывает выданный `magic-token` обратно в приложение и рендерит страницу запроса ссылки для мобильного клиента, обеспечивая безопасный редирект с `referer` на базовый URL.【F:src/login/index.php†L32-L43】【F:src/common/libs/Auth/main.php†L18-L43】

### Мобильный JWT-поток
- Мобильные клиенты отправляют JWT в `POST` (ключ `jwt`); сервер декодирует его с помощью `AUTH_JWTKey`, разрешая только типы `app-v1` и `app-v2-magic-email`, и при успехе извлекает вложенный `authTokens_token` для дальнейшей проверки IP и TTL.【F:src/common/libs/Auth/main.php†L26-L75】
- После интерактивного входа мобильный клиент получает JWT через `issueJWT`, включающий идентификатор токена, пользователя, тип устройства и 12-часовой срок действия; это JWT хранится на устройстве и предъявляется при каждом запуске, формируя безпарольный вход до истечения TTL.【F:src/common/libs/Auth/main.php†L282-L294】

### OAuth через Google
- Контроллер проверяет наличие ключей `AUTH_PROVIDERS_GOOGLE_KEYS_ID`/`SECRET`, настраивает Hybridauth c соответствующим callback и scope из конфигурации и инициирует аутентификацию; любые ошибки состояния отображаются пользователю.【F:src/login/oauth/google.php†L6-L43】
- После успешного ответа профиль проверяется на наличие идентификатора и подтверждённого email; при совпадении с существующей учётной записью выполняется проверка блокировки, опциональная верификация email и выдача токена (web или app OAuth).【F:src/login/oauth/google.php†L46-L84】
- Если пользователь найден только по email, система останавливает процесс и требует ручной привязки; при отсутствии учётки и разрешённой регистрации создаётся новый пользователь с параметрами из профиля и запускается стандартный поток выдачи токена.【F:src/login/oauth/google.php†L85-L132】

### OAuth через Microsoft
- Аналогичный контроллер использует `AUTH_PROVIDERS_MICROSOFT_APP_ID`/`SECRET`, запрашивает scope `openid user.read` и tenant `common`; при недоступности конфигурации пользователя возвращают на стандартную форму входа.【F:src/login/oauth/microsoft.php†L6-L33】
- При успешном ответе проверяются идентификатор и статус блокировки; существующим пользователям выдаётся веб-токен, а несвязанные email требуют входа по паролю перед привязкой, после чего возможна автоматическая регистрация при разрешённой подписке.【F:src/login/oauth/microsoft.php†L35-L105】

### Процесс выхода
- Запрос `?logout` на странице входа вызывает `logout()`, который деактивирует токен в базе и очищает сессию, обеспечивая мгновенный выход и редирект на корневой URL.【F:src/login/index.php†L22-L25】【F:src/common/libs/Auth/main.php†L296-L305】

## Сценарий работы пользователей
1. Пользователь открывает `/login`, где контроллер проверяет, выполнен ли вход, и подготавливает форму со списком доступных методов, включая локальный пароль, магические ссылки и OAuth-провайдеров.【F:src/login/index.php†L6-L43】
2. При вводе логина/пароля или получении магической ссылки сервер вызывает `generateToken`, фиксируя IP, устройство и привязку администратора (если вход «от лица»), затем кладёт токен в сессию или выдаёт JWT для приложений.【F:src/common/libs/Auth/main.php†L231-L294】
3. Если выбран Google или Microsoft OAuth, соответствующий контроллер инициирует Hybridauth-поток, сверяет профиль с учётной записью и после успеха выдаёт токен с теми же ограничениями IP/TTL, что и стандартный вход.【F:src/login/oauth/google.php†L6-L132】【F:src/login/oauth/microsoft.php†L6-L105】【F:src/common/libs/Auth/main.php†L49-L75】
4. Мобильное приложение сохраняет выданный JWT и на последующих запросах отправляет его в `POST`, после чего сервер проверяет срок действия, IP и флаги блокировки пользователя, прежде чем завершить вход и загрузить данные инстанса.【F:src/common/libs/Auth/main.php†L26-L94】
5. При выходе из системы (на вебе или в мобильном клиенте) вызывается `logout()`, токен помечается недействительным, а повторный вход потребует новую выдачу токена по одному из поддерживаемых потоков.【F:src/login/index.php†L12-L25】【F:src/common/libs/Auth/main.php†L296-L305】

## Конфигурационные ключи `AUTH_*`
- `AUTH_SIGNUP_ENABLED` — управляет возможностью само-регистрации; значения `Enabled/Disabled`, доступно через форму конфигурации и ENV `CONFIG_SIGNUP_ENABLED`.【F:src/common/libs/Config/configStructureArray.php†L301-L321】
- `AUTH_JWTKey` — обязательный 64-символьный секрет для подписи JWT; при изменении инвалидирует существующие токены. Допускается заполнение через ENV `CONFIG_AUTH_JWTKey` или генерация по умолчанию.【F:src/common/libs/Config/configStructureArray.php†L322-L349】
- `AUTH_NEXTHASH` — алгоритм хеширования для новых паролей (`sha256` или `sha512`); позволяет планово мигрировать парольную политику.【F:src/common/libs/Config/configStructureArray.php†L351-L371】
- `AUTH_PROVIDERS_GOOGLE_KEYS_ID`/`SECRET` и `AUTH_PROVIDERS_GOOGLE_SCOPE` — настраивают клиент и область доступа Google OAuth; документация напоминает про обязательные redirect URI `/login/oauth/google.php` и `/api/account/oauth-link/google.php`.【F:src/common/libs/Config/configStructureArray.php†L372-L436】
- `AUTH_PROVIDERS_MICROSOFT_APP_ID`/`SECRET` — аналогичные параметры для Microsoft OAuth с redirect URI `/login/oauth/microsoft.php` и `/api/account/oauth-link/microsoft.php`.【F:src/common/libs/Config/configStructureArray.php†L437-L478】

## Требования к 2FA и политикам безопасности
- Поддерживаются методы TOTP, WebAuthn и резервный Email OTP; администраторы могут принудительно включать 2FA для ролей, определять политику восстановления и выдавать резервные коды при онбординге (wizard при первом входе).【F:Readme.md†L1661-L1665】
- Процесс входа включает проверку rate-limit, 2FA (если включена), аудит успеха и поток восстановления через магические ссылки и TTL токенов; заблокированные пользователи переводятся в workflow `ACCOUNT:SUSPEND_USER`.【F:Readme.md†L1667-L1672】
- Рекомендуется поддерживать политику паролей, контроль сессий и уведомления о входах с новых устройств для своевременного реагирования на инциденты.【F:Readme.md†L1681-L1685】

## Best practices для администраторов
- Делегируйте роли и MFA для критичных пользователей, используя стандартные и кастомные роли, а также обязательную MFA для повышенных прав.【F:Readme.md†L327-L336】
- Регулярно анализируйте журналы входов и событий безопасности в разделе Server → Logs, сопоставляйте данные с Sentry breadcrumbs и HR-реестрами и автоматизируйте offboarding с отзывом токенов.【F:Readme.md†L339-L349】
- Для продакшен-развёртывания задайте корректный `ROOTURL`, уникальный `AUTH_JWTKey`, отключите `DEV_MODE`, настройте почтовый домен и следите за корректной передачей реального IP через прокси.【F:Readme.md†L246-L255】

## Таблица прав, влияющих на аутентификацию

| Разрешение | Влияние на аутентификацию | Зависимости/особенности |
| --- | --- | --- |
| `USERS:EDIT:SUSPEND` | Позволяет блокировать пользователей, предотвращая выдачу новых токенов и входы до снятия блокировки.【F:src/common/libs/Auth/serverActions.php†L64-L75】 | Требует права просмотра пользователей (`USERS:VIEW`).【F:src/common/libs/Auth/serverActions.php†L64-L69】 |
| `USERS:DELETE` | Удаление учётной записи отзывается токены и очищает доступ; критично для управления компрометированными аккаунтами.【F:src/common/libs/Auth/serverActions.php†L76-L87】 | Требует `USERS:VIEW` для идентификации пользователя.【F:src/common/libs/Auth/serverActions.php†L76-L82】 |
| `USERS:VIEW_SITE_AS` | Доступ «просмотреть сайт как» использует `authTokens_adminId`, создавая прокси-токены и требуя строгого контроля администратора.【F:src/common/libs/Auth/main.php†L90-L99】【F:src/common/libs/Auth/serverActions.php†L112-L123】 | Зависит от набора прав `USERS:VIEW`, `USERS:EDIT`, `USERS:VIEW:MAILINGS`, `USERS:EDIT:SUSPEND` для предотвращения злоупотреблений.【F:src/common/libs/Auth/serverActions.php†L112-L118】 |
| `INSTANCES:FULL_PERMISSIONS_IN_INSTANCE` | Позволяет серверным администраторам заходить в любой инстанс с полными правами; при веб-сессии загружает дополнительные данные и расширяет область токена.【F:src/common/libs/Auth/main.php†L172-L189】【F:src/common/libs/Auth/serverActions.php†L148-L159】 | Требует право `INSTANCES:VIEW`; применяется только к токенам `web-session`.【F:src/common/libs/Auth/serverActions.php†L148-L156】 |
| `PERMISSIONS:VIEW` | Доступ к матрице прав позволяет аудировать, кто имеет вход и какие права влияют на выдачу токенов.【F:src/common/libs/Auth/serverActions.php†L205-L210】 | Нет зависимостей, но рекомендуется ограничивать только доверенным администраторам.【F:src/common/libs/Auth/serverActions.php†L205-L210】 |

## Чек-лист отладки проблем входа
1. Убедитесь, что заданы `ROOTURL`, `AUTH_JWTKey` и отключён `DEV_MODE`; проверьте почтовые настройки и DNS (SPF/DKIM/DMARC).【F:Readme.md†L246-L254】
2. Проверяйте логи контейнеров и параметры БД/ENV, если приложение не стартует или повторно показывает форму конфигурации.【F:Readme.md†L258-L263】
3. При проблемах с письмами или магическими ссылками убедитесь, что `EMAILS_ENABLED=Enabled` и корректно настроен провайдер либо Mailpit в dev-окружении.【F:Readme.md†L264-L266】
4. Для OAuth-потоков подтвердите redirect URI в консолях Google/Microsoft согласно конфигурации `AUTH_PROVIDERS_*`.【F:Readme.md†L268-L269】【F:src/common/libs/Config/configStructureArray.php†L372-L478】
5. Проверяйте соответствие IP-адресов: заголовки `CF-Connecting-IP`/`X-Forwarded-For` должны проксироваться до приложения, иначе `AuthFail` завершит проверку токена.【F:src/common/libs/Auth/main.php†L58-L71】【F:Readme.md†L252-L255】
6. При подозрении на устаревшие токены инициируйте `logout()` или отзыв сессии в БД; токен получит флаг `authTokens_valid = 0` и перестанет проходить проверку.【F:src/common/libs/Auth/main.php†L296-L305】
