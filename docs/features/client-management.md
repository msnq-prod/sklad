# Управление клиентами

Эта страница описывает функциональность списка клиентов и связанные рабочие процессы. Материал предназначен для менеджеров инстанса и сотрудников поддержки, которые готовят отчёты, обновляют карточки и следят за корректностью финансовых данных.

## Навигация и доступ

- Страница `Клиенты` доступна всем пользователям, обладающим правом `CLIENTS:VIEW`. Без него контроллер немедленно возвращает страницу `404`.【F:src/clients.php†L3-L11】
- После загрузки система фиксирует поисковый запрос и параметры фильтрации в массиве `$PAGEDATA`, чтобы интерфейс мог подсветить активные параметры и повторно применить их при пагинации.【F:src/clients.php†L13-L15】【F:src/clients.php†L21-L25】

## Фильтры и поиск

### Поиск

- Текстовое поле поиска фильтрует клиентов по имени, адресу, e-mail, сайту, телефону и заметкам. В запрос добавляется несколько выражений `LIKE`, что позволяет искать по подстроке без учёта регистра.【F:src/clients.php†L26-L36】
- Поиск комбинируется с любыми другими фильтрами и пагинацией.

### Архив

- Флаг `archive` переключает между активными и архивными клиентами. Без параметра отображаются только активные записи (`clients_archived = 0`), при `archive=1` — архив (`clients_archived = 1`). В обоих случаях игнорируются удалённые записи (`clients_deleted = 0`).【F:src/clients.php†L16-L24】

### Будущие проекты

- По умолчанию список проектов, участвующих в расчётах по клиенту, ограничен завершёнными или уже прошедшими проектами (`projects_dates_use_end < текущая дата`). Это исключает будущие мероприятия и снижает шум в задолженностях.【F:src/clients.php†L41-L47】
- Параметр `future=1` снимает ограничение по дате и добавляет будущие проекты, что полезно для прогнозирования загрузки и предстоящих платежей.【F:src/clients.php†L41-L49】

### Учитывать выданные активы

- Без параметра `released` подсчёт задолженностей исключает проекты, для которых активы уже выданы (`projectsStatuses_assetsReleased = 1`). Это помогает фокусироваться на проектах, требующих дальнейшего внимания.【F:src/clients.php†L12-L14】【F:src/clients.php†L51-L54】
- Добавление `released=1` включает такие проекты в агрегированную сумму задолженности.

## Расчёт финансовых показателей

1. Для каждого клиента выбираются связанные проекты по текущему инстансу. Фильтруются удалённые записи и проектные типы, в настройках которых разрешены финансы (`projectsTypes_config_finance = 1`).【F:src/clients.php†L37-L46】
2. Для каждого проекта подтягивается последняя запись из кэша `projectsFinanceCache`, в которой хранятся агрегированные суммы оплат, скидок и итоговых стоимостей. Отсутствие кэша рассматривается как критическая ошибка и выбрасывает исключение, так что службе поддержки следует регенерировать кэш перед анализом.【F:src/clients.php†L55-L61】
3. Сумма поступивших платежей накапливается независимо от флага `released`, что позволяет видеть полный объём оплат по клиенту.【F:src/clients.php†L52-L53】【F:src/clients.php†L61-L63】
4. Сумма задолженности (`grandTotal`) накапливается только для проектов, которые не отмечены как «активы выданы», если фильтр `released` не активирован.【F:src/clients.php†L51-L54】【F:src/clients.php†L63-L67】
5. Все вычисления выполняются через библиотеку `Money`, которая использует валюту инстанса из профиля пользователя. При отображении суммы автоматически форматируются в выбранной валюте.【F:src/clients.php†L7-L8】【F:src/clients.php†L48-L67】

## Рабочие процессы

### Сценарий ежедневной работы аккаунт-менеджера

1. Утром менеджер открывает список клиентов с фильтром по активным карточкам, чтобы увидеть текущую воронку.
2. Через поиск проверяет, появились ли новые обращения или изменения в компаниях, с которыми ведётся работа.
3. Для каждого клиента с ближайшими мероприятиями включает фильтр `future=1`, оценивает ожидаемые платежи и при необходимости связывается с ответственными лицами.
4. Если в ходе общения клиент подтверждает получение оборудования или закрытие проекта, менеджер обновляет статус и переносит карточку в архив либо отмечает выдачу активов.
5. В конце дня формирует выгрузку для финансового отдела, используя раздел экспорта, и передаёт её вместе с заметками о проведённых изменениях.

### Обновление карточки клиента

1. Найдите клиента через поиск или фильтры.
2. Откройте карточку, проверьте корректность контактных данных и статуса (активный/архивный).
3. При необходимости измените категорию проекта или обновите заметки, чтобы последующие отчёты отражали актуальную информацию.
4. После сохранения вернитесь в список и убедитесь, что карточка отображается в нужном разделе (активные или архив).

### Подготовка финансового отчёта

1. Включите фильтр `future=1`, если нужно увидеть будущие проекты.
2. При необходимости активируйте `released=1`, чтобы включить проекты с выданными активами в задолженность.
3. Экспортируйте список (см. раздел «Экспорт») или вручную соберите суммы по нужному клиенту, используя отображаемые значения оплат и задолженностей.
4. Сверьте данные с финансовым модулем (см. ниже), особенно если замечены пропуски в кэше.

### Экспорт списка

1. Отфильтруйте клиентов по нужным критериям (поиск, архив, будущие проекты, выданные активы).
2. Используйте стандартный инструмент экспорта (например, CSV/Excel), доступный в интерфейсе списка. Если встроенного экспорта нет, сформируйте выгрузку через API или сохраните представление из браузера.
3. Перед отправкой отчёта убедитесь, что в выгрузке нет дублированных или устаревших клиентов.

## Чистота данных

- Регулярно проверяйте архивные карточки: перенесите устаревшие компании в архив, но не удаляйте их, чтобы сохранить историю проектов.
- Поддерживайте единый формат контактных данных (телефон, e-mail), чтобы поиск срабатывал корректно.
- После крупных изменений в тарифах или ценах инициируйте обновление `projectsFinanceCache`, чтобы расчёты задолженностей соответствовали текущим условиям.
- Используйте заметки для фиксации нестандартных договорённостей; это исключит двойную работу при подготовке отчётов.

## Интеграция с финансовым модулем

- Кэш `projectsFinanceCache` обновляется фоновыми задачами или при пересчёте проекта. Если суммы не сходятся, принудительно обновите проект или обратитесь к администратору для регенерации кэша.【F:src/clients.php†L55-L61】
- Финансовый модуль использует те же права доступа: пользователю требуется минимум `CLIENTS:VIEW` для просмотра сумм. Для редактирования проектов/финансов могут потребоваться дополнительные разрешения (`PROJECTS:EDIT`, `FINANCE:MANAGE`), их настройка выполняется администратором инстанса.
- Перед экспортом данных сверьтесь с бухгалтерией: при необходимости загрузите суммы напрямую из финансового модуля, чтобы учесть платежи, которые ещё не успели попасть в кэш.

## Как работает список клиентов простыми словами

1. **Открываем страницу.** Если у вас есть право `CLIENTS:VIEW`, вы попадаете в общий список компаний. Система сразу запоминает, какие фильтры вы включили, чтобы не сбрасывать их при переключении страниц.
2. **Фильтруем и ищем.** Строка поиска находит клиента по любому полю: названию, телефону, почте и даже заметкам. Дополнительные переключатели позволяют показать только архив или добавить будущие проекты и проекты с выданными активами.
3. **Смотрим цифры.** Для каждого клиента суммируются оплаченные счета и задолженность. Данные берутся из кэша финансовых расчётов, поэтому цифры обновляются быстро, а валюту система подставляет автоматически.
4. **Работаем с карточками.** Открыв клиента, можно изменить контакты, статус или заметки. После сохранения изменения сразу отражаются в списке, а при необходимости карточку переносят в архив.
5. **Готовим отчёт.** Когда фильтры настроены, экспортируем список или выписываем суммы вручную. Если нужны точные цифры по оплатам, сверяемся с финансовым модулем или обновляем кэш.
6. **Следим за порядком.** Регулярно приводим контакты к единому виду, чтобы поиск срабатывал, и проверяем, не устарели ли статусы проектов. Это помогает всей команде быстро понимать ситуацию по клиенту.

