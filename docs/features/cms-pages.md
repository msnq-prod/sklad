# CMS Pages

Документ описывает управление страницами CMS в AdamRMS: от загрузки контента и контроля видимости до ревизий, виджетов и восстановления удалённых страниц.

## Загрузка и отображение страниц
- **Источник контента.** Каждая страница хранится в базе данных как ревизируемый документ с полями заголовка, slug и тела (Twig-разметка + данные). При загрузке контроллер обращается к актуальной ревизии и готовит контекст `$PAGEDATA`.
- **Маршрутизация.** `src/index.php` проверяет запрошенный путь; если путь не совпадает с встроёнными страницами, выполняется поиск по CMS slug. При успешном совпадении Twig-шаблон рендерится через `$TWIG`.
- **Кэширование.** Страницы рендерятся с учётом конфигурации экземпляра (`$CONFIG`); чтобы избежать устаревших данных, после сохранения страницы следует очистить кэш CDN (если используется CloudFront) и invalidate локальные reverse-прокси.

## Ограничения видимости
- **Уровни доступа.** Страницы поддерживают публичный, по ссылке и приватный режимы. Для приватного режима требуется авторизация: контроллер подключает `headSecure.php`, а `$AUTH->instancePermissionCheck('CMS:VIEW')` проверяет права пользователя.
- **Ограничения по экземплярам.** В экземплярах (instances) можно переопределять видимость страницы. Проверяйте `instanceId` в `$AUTH->data` и сравнивайте с полем страницы, чтобы не показывать чужой контент.
- **Временные ограничения.** Для акций используйте поля `publish_at` и `expire_at`. Контроллер должен скрывать страницу, если текущее время вне диапазона.

## Ревизии и аудит просмотров
- **Хранение версий.** Каждое сохранение создаёт новую запись в таблице `cmsPageRevisions`. Записывайте автора (`userId`) и хеш содержимого для обнаружения совпадений.
- **Просмотр ревизий.** UI должен отображать список ревизий с diff по полю `content`. Для сравнения используйте подсветку изменений, например через встроенный Twig-фильтр `diff` или клиентскую библиотеку.
- **Восстановление версии.** При откате выберите ревизию и создайте новую ревизию с её содержимым (история остаётся линейной).
- **Аналитика просмотров.** Вызов `$bCMS->logPageView($pageId, $userId, $instanceId)` фиксирует факт просмотра, что используется в аналитике и расчётах популярности.

## Редактирование и рабочий процесс
- **UI редактирования.** Форма должна загружать текущую ревизию, предоставлять редактор Markdown/Twig и предпросмотр. Валидируйте уникальность slug и структуру JSON для виджетов.
- **Контроль доступа.** Разрешайте редактирование только пользователям с `CMS:EDIT`. Для публикации требуйте `CMS:PUBLISH`, а для удаления — `CMS:ARCHIVE`.
- **Процесс публикации.** Рекомендуемый workflow: черновик → ревью → публикация. Используйте флаги `draft` и `needs_review`. После одобрения публикуйте ревизию, автоматически уведомляя заинтересованные команды.
- **Откат.** Предоставьте кнопку «Откатить» с подтверждением. Откат создаёт новую ревизию с данными выбранной версии и отмечает автора отката.

## Управление виджетами и интеграция с дашбордом
- **Виджеты.** Блоки виджетов управляются JSON-конфигурацией. Для каждого виджета храните тип, параметры и права доступа. При рендере подключайте Twig-шаблоны из `src/assets/widgets` через `include`.
- **Совместное использование данных.** Виджеты могут обращаться к API для загрузки статистики. Кэшируйте результаты на стороне контроллера или используйте Telemetry, чтобы не перегружать базу.
- **Дашборд.** CMS-страницы могут быть закреплены в главном дашборде как карточки. Добавьте настройку в `Config` (например, `CMS_DASHBOARD_PAGES`) и отображайте их через `statsWidgets.php`.

## Рекомендации по структуре контента и доступу
- **Структура.** Используйте короткие slug (kebab-case), логическую иерархию (`/guides/getting-started`), заголовки H1-H3, таблицы для структурированных данных и call-to-action блоки.
- **Мультимедиа.** Загружайте файлы через S3 и вставляйте ссылки с фильтром `|s3URL`. Добавляйте текстовые альтернативы для изображений.
- **Контроль доступа.** Чётко разграничивайте роли: автор, редактор, издатель, администратор. Назначайте права через `serverPermissionCheck`/`instancePermissionCheck`.
- **Публикация и ревью.** Для черновиков используйте отдельную директорию в навигации. Настройте уведомления (email/Slack) о новых ревизиях и статусах ревью. Сроки проверки фиксируйте в аналитике.

## Устранение ошибок и восстановление страниц
- **Дебаг загрузки.** Если страница не отображается, проверьте лог `analyticsEvents` и ошибки Twig/Sentry. Убедитесь, что slug уникален и нет конфликтов с системными маршрутами.
- **Проблемы с видимостью.** Проверяйте права пользователя, актуальность `publish_at/expire_at` и привязку к экземпляру. Для публичных страниц убедитесь, что CDN не кэширует 403/404.
- **Восстановление удалённых/архивных страниц.** Удаление переводит страницу в статус `archived`. Для восстановления найдите запись в таблице `cmsPages`, сбросьте флаг `archived` и выберите нужную ревизию как активную. При полном удалении используйте резервные копии БД или S3 snapshots.
- **Инциденты с ревизиями.** Если ревизия повреждена, найдите последнюю корректную версию по хешу содержимого и восстановите из неё новую ревизию. Проверяйте, что `content` проходит валидацию и не содержит небезопасных Twig-вставок.

## Дополнительные рекомендации
- Автоматизируйте экспорт страниц (например, nightly job) для внешнего бэкапа.
- Настройте мониторинг количества 404 по CMS slug для выявления устаревших ссылок.
- Документируйте процессы ревью и восстановления, чтобы новые администраторы быстро включались в работу.

## Пользовательский сценарий
1. **Автор создаёт черновик.** Пользователь с правами `CMS:EDIT` заходит в редактор, вводит контент, настраивает виджеты и сохраняет ревизию со статусом `draft`.
2. **Редактор проверяет контент.** Пользователь с ролью ревьюера получает уведомление, просматривает предпросмотр страницы, оставляет комментарии и переводит статус в `needs_review` или одобряет для публикации.
3. **Издатель публикует страницу.** Ответственный с разрешением `CMS:PUBLISH` проверяет финальные изменения, устанавливает расписание (`publish_at`, `expire_at`) и активирует ревизию.
4. **Читатели потребляют контент.** Публичные пользователи или участники экземпляра открывают страницу; система логирует просмотры, применяет ограничения доступа и отображает закреплённые виджеты на дашборде.
5. **Администратор анализирует и поддерживает.** Через дашборд и отчёты администратор отслеживает просмотры, управляет архивом, при необходимости откатывает версию или восстанавливает страницу из архива.

## CMS простыми словами

Если кратко, работа с CMS-страницами выглядит так:

1. **Создать страницу.** Зайдите в раздел CMS, нажмите «Новая страница», придумайте короткий адрес (slug) и заполните текст. Если нужны блоки с данными, добавьте подходящие виджеты — система подскажет, какие поля заполнить.
2. **Сохранить черновик.** Нажмите «Сохранить как черновик». Страница никуда не публикуется, но вы уже можете посмотреть предпросмотр и поделиться ссылкой с коллегами.
3. **Отправить на проверку.** Поставьте статус «На проверке», чтобы редактор получил уведомление. Он увидит ваши правки, сможет оставить комментарии и предложить улучшения.
4. **Опубликовать.** Когда всё готово, издатель нажимает «Опубликовать» или ставит расписание, если страница должна выйти позже. С этого момента она доступна тем, у кого есть права (публично, по ссылке или только внутри компании).
5. **Следить за результатом.** После публикации смотрите аналитику просмотров, проверяйте, как работают виджеты, и обновляйте контент при необходимости.
6. **Исправить ошибки или откатить.** Если что-то пошло не так, откройте список версий, выберите нужную ревизию и восстановите её одной кнопкой. Удалённые страницы можно вернуть из архива — просто снимите отметку «архив».

Такой цикл повторяется для каждой важной страницы: создаём, согласуем, публикуем, наблюдаем и при необходимости быстро исправляем.
