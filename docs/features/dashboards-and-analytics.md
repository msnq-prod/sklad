# Дашборды и аналитика

## Загрузка и жизненный цикл виджетов
- Все защищённые страницы подключают класс `statsWidgets`, который собирает набор дашбордных карточек на основе предпочтений пользователя и режимов показа.【F:src/common/headSecure.php†L1-L35】
- Конструктор формирует список доступных виджетов, фильтрует исключённые пользователем элементы и предоставляет Twig-совместимый интерфейс для рендеринга блоков через методы `getAllDashboard()` и `widget()`.【F:src/assets/widgets/statsWidgets.php†L11-L41】
- По умолчанию доступны карточки о динамике стоимости и массы активов, суммарной инвентаризации, загрузке хранилища, численности команды, задачах по обслуживанию и персональном календаре. Каждый виджет получает параметры `instanceid`/`userid` и строит агрегаты на основе запросов в `MysqliDb`.【F:src/assets/widgets/statsWidgets.php†L46-L200】
- При открытии панели без CMS-страницы `statsWidgets` инициализируется в пользовательском режиме (учитывает скрытые карточки), а при просмотре CMS-дашборда — в административном режиме (`showAll=true`), чтобы показать весь набор виджетов рядом с контентом страницы.【F:src/index.php†L39-L49】

## CMS-страницы на дашборде и права доступа
- Если у инстанса выбрана CMS-страница по умолчанию и у пользователя есть позиция, система проверяет публикацию, архивный статус и ограничения по группам, после чего отображает страницу вместо стандартного дашборда и фиксирует просмотр в `cmsPagesViews`. Дополнительно можно открыть конкретную ревизию при наличии права `CMS:CMS_PAGES:EDIT`.【F:src/index.php†L16-L38】
- Для стандартного дашборда и встроенных CMS-страниц виджеты статистики отображаются только при разрешении `BUSINESS:BUSINESS_STATS:VIEW`; переключение инстансов серверными администраторами контролируется правом `INSTANCES:FULL_PERMISSIONS_IN_INSTANCE`.【F:src/index.php†L6-L12】【F:src/index.php†L39-L49】
- Все защищённые страницы логируют посещения в таблицу `analyticsEvents`, включая пользователя, инстанс, токен авторизации, URL и GET-параметры, что обеспечивает непрерывный аудит переходов по дашбордам и CMS-страницам.【F:src/common/headSecure.php†L26-L35】

## Серверная аналитика
### Контроллеры и доступ
- Серверный раздел аналитики доступен только администраторам с правом `VIEW-ANALYTICS`; контроллер `index.php` собирает общее число записей в `analyticsEvents` и передаёт его в Twig-шаблон обзора.【F:src/server/analytics/index.php†L1-L9】
- Подразделы `pageViews.php` и `tables.php` наследуют те же проверки прав перед обработкой данных, блокируя доступ без серверных полномочий аналитика.【F:src/server/analytics/pageViews.php†L1-L6】【F:src/server/analytics/tables.php†L1-L6】

### Хранимые метрики
- Таблица `analyticsEvents` фиксирует действия `PAGE-REQUEST` и `API-CALL`, что позволяет агрегировать просмотры по пользователям, путям и временным срезам; отчёт `pageViews.php` строит подсчёты, группируя запросы по пользователю, URL и часам/дням недели.【F:src/server/analytics/pageViews.php†L14-L27】
- Отчёт `tables.php` перечисляет ключевые доменные таблицы (активы, клиенты, CMS, аудит, проекты, пользователи и др.) и добавляет их размеры в общий итог, что помогает контролировать рост данных и планировать обслуживание базы.【F:src/server/analytics/tables.php†L7-L22】

### Доступные отчёты
- Обзорный экран отображает суммарное число записанных событий и предоставляет быстрые ссылки к деталям просмотров страниц и статистике таблиц, подчёркивая, что метрики охватывают весь сервер и все инстансы.【F:src/server/analytics/analytics_index.twig†L4-L37】

## Кастомизация и работа с дашбордами
### Расширение набора виджетов
- Комментарий в `statsWidgets.php` описывает пошаговое добавление новых карточек: создать Twig-шаблон, класс-метод, зарегистрировать его в `$widgetsList` и добавить в шаблон списка виджетов. Следуйте этим шагам, чтобы обеспечить корректное подключение новых источников данных.【F:src/assets/widgets/statsWidgets.php†L4-L29】
- При разработке новых метрик используйте существующие примеры: `inventoryValueGraph` формирует временной ряд по стоимости и массе активов, `inventoryTotal` суммирует стоимость и массу, `storageUsage` оценивает хранилище, а `maintenanceOutstanding`/`myMaintenance` и `myCalendar` помогают планировать задачи и занятость персонала.【F:src/assets/widgets/statsWidgets.php†L56-L200】

### Работа с CMS-дашбордами
- Чтобы закрепить CMS-страницу в качестве стартового дашборда, назначьте `cmsPages_id` в настройках инстанса: при загрузке система проверит доступность страницы и отобразит её вместе со статистикой (если разрешено). В журнал просмотров автоматически попадёт событие с типом `cmsPages_type = 3`, что позволяет отслеживать вовлечённость в внутренние публикации.【F:src/index.php†L16-L40】

### Интерпретация ключевых метрик
- Рост суммарной стоимости и массы активов по временным точкам (`inventoryValueGraph`) показывает инвестиции и обновление парка; используйте шкалу, подобранную автоматически (годы, кварталы, месяцы, недели) для анализа трендов.【F:src/assets/widgets/statsWidgets.php†L56-L113】
- Карточка `inventoryTotal` даёт текущее значение стоимости и массы активов, полезное для сверки с бухгалтерией, а `storageUsage` помогает следить за лимитами хранения в S3. Карточка `userCount` показывает активных пользователей инстанса, позволяя контролировать лицензии.【F:src/assets/widgets/statsWidgets.php†L46-L132】
- Блоки обслуживания (`maintenanceOutstanding`, `myMaintenance`) и календарь (`myCalendar`) подсвечивают загрузку команды и просрочки, формируя оперативную повестку для менеджеров и исполнителей.【F:src/assets/widgets/statsWidgets.php†L134-L204】

## Сценарий работы пользователей
1. Серверный администратор выбирает или переключает инстанс через параметр `i` в URL, после чего система обновляет контекст и возвращает пользователя на дашборд.【F:src/index.php†L6-L13】
2. Если для инстанса настроена CMS-страница, система проверяет права, загружает последнюю ревизию и фиксирует просмотр, одновременно включая все виджеты при наличии права на статистику.【F:src/index.php†L16-L41】
3. При отсутствии закреплённой CMS-страницы или после закрытия контента `statsWidgets` собирает персонализированный набор карточек, отфильтровывая скрытые элементы и подготавливая данные для Twig-шаблонов.【F:src/assets/widgets/statsWidgets.php†L11-L41】
4. Каждая карточка получает идентификаторы пользователя и инстанса, вычисляет агрегаты (стоимость активов, загрузка склада, задачи обслуживания, календарь) и возвращает их на дашборд для оперативного анализа.【F:src/assets/widgets/statsWidgets.php†L46-L204】
5. Все действия пользователя записываются в `analyticsEvents`, что позволяет аналитикам просматривать историю обращений к дашбордам и формировать отчёты в серверном модуле аналитики.【F:src/common/headSecure.php†L26-L35】【F:src/server/analytics/index.php†L1-L9】

## Аудиты, логи и интеграции с BI
- Метод `bCMS->auditLog()` сохраняет действия с указанием типа операции, таблицы, связанных пользователей и проекта, обеспечивая формирование неизменяемого аудита. Используйте его при расширении функциональности, чтобы фиксировать важные события в системе учёта.【F:src/common/libs/bCMS/bCMS.php†L68-L83】
- Центральное логирование посещений через `analyticsEvents` позволяет строить серверные отчёты и служит источником данных для внешних инструментов мониторинга.【F:src/common/headSecure.php†L26-L35】
- Для интеграции с внешними BI-платформами используйте API и экспортные механизмы, описанные в общем руководстве: модуль аналитики поддерживает передачу данных в Power BI, Tableau, Looker и другие системы через коннекторы и ETL-процессы, а также планировщик отчётов и публикацию в корпоративные каналы.【F:Readme.md†L1202-L1229】

## Простое руководство: что происходит шаг за шагом
1. Вы открываете веб-приложение и входите в систему: защищённая обвязка проверяет сессию и готовит список ваших прав, чтобы показать только разрешённые разделы дашборда.【F:src/common/headSecure.php†L1-L35】
2. Приложение определяет, в каком инстансе вы работаете, и при необходимости переключает его по параметру `i`, чтобы все виджеты и страницы подтянули данные именно этого бизнеса.【F:src/index.php†L6-L13】
3. Если для инстанса назначена стартовая CMS-страница, система проверяет, можно ли вам её видеть, загружает свежую версию и показывает вместе с наборами статистики, если у вас есть доступ к виджетам.【F:src/index.php†L16-L41】
4. Когда нужен стандартный дашборд, движок `statsWidgets` собирает персональный набор карточек: убирает скрытые элементы, подставляет ваши идентификаторы и запрашивает числа для каждого блока (стоимость активов, склад, задачи, календарь и т. д.).【F:src/assets/widgets/statsWidgets.php†L11-L204】
5. Каждый виджет отправляет данные в Twig-шаблоны, и вы видите карточки с цифрами и графиками прямо на домашней странице или в CMS-разделе, не переключаясь между экранами.【F:src/index.php†L39-L49】【F:src/assets/widgets/statsWidgets.php†L11-L132】
6. Любое открытие страницы или действия с API заносятся в `analyticsEvents`, так что позже администраторы могут посмотреть отчёты по посещаемости и активности в серверном разделе аналитики.【F:src/common/headSecure.php†L26-L35】【F:src/server/analytics/index.php†L1-L9】
