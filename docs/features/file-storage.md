# Хранилище файлов

## Общая архитектура

AdamRMS использует таблицу `s3files` и AWS S3 (или совместимые API) для хранения файлов, дополняя её CloudFront при наличии CDN.
Все обращения к файлам проходят через вспомогательные методы `bCMS`, которые проверяют метаданные, истечения сроков и права, прежде чем сформировать временную ссылку на объект S3 или CloudFront.【F:src/common/libs/bCMS/bCMS.php†L145-L227】

## Правила безопасности и видимости файлов

- **secure** — флаг, требующий аутентификацию пользователя. Включён для всех типов файлов, кроме перечисленных исключений (`[2,5,10,15,16,17]`).【F:src/common/libs/bCMS/bCMS.php†L166-L177】
- **requireInstance** — ограничение на доступ только пользователям той же инстанции. По умолчанию активно, кроме типов `[2,5,9,10,15,16,17]`. Файлы с таким требованием автоматически считаются `secure`.【F:src/common/libs/bCMS/bCMS.php†L166-L177】
- После проверки флагов метод `s3URL` возвращает ссылку только если пользователь авторизован и, при необходимости, принадлежит к нужной инстанции.【F:src/common/libs/bCMS/bCMS.php†L175-L183】
- Публичный доступ возможен только при предоставлении действующего share-ключа: хэш совпадает — ограничение `secure` снимается, иначе файл остаётся закрытым.【F:src/common/libs/bCMS/bCMS.php†L178-L182】

### Очистка и истечение

Перед выдачей ссылки система убеждается, что файл не помечен на удаление (`s3files_meta_deleteOn`) и физически присутствует в S3, иначе доступ блокируется. Используйте это поле для планирования автоочистки и гарантии, что просроченные файлы не скачиваются.【F:src/common/libs/bCMS/bCMS.php†L155-L160】【F:src/common/libs/bCMS/bCMS.php†L125-L140】

## Генерация ссылок и параметры `s3URL`

Метод `s3URL($fileId, $forceDownload = false, $expire = '+10 minutes', $shareKey = false)`:

- `fileId` — идентификатор файла в `s3files`, проходит санитизацию.
- `forceDownload` (`d` в API) задаёт `Content-Disposition` (`attachment` vs `inline`).【F:src/common/libs/bCMS/bCMS.php†L193-L225】
- `expire` (`e` в API) определяет срок действия пресайна. Если не указан или `null`, для защищённых типов по умолчанию выставляется `+1 minute` для минимизации риска утечки.【F:src/common/libs/bCMS/bCMS.php†L162-L163】
- `shareKey` — хэш публичного ключа из `/api/file/share.php`; при совпадении снимает требование авторизации.【F:src/common/libs/bCMS/bCMS.php†L178-L182】【F:src/api/file/share.php†L7-L15】

Возвращаемое значение — временный URL CloudFront (если включён) или presigned S3, оформленный с корректным `response-content-disposition` для указанного режима загрузки.【F:src/common/libs/bCMS/bCMS.php†L185-L226】

### Обработка публичных share-ключей

- Endpoint `/api/file/share.php` генерирует случайный ключ, сохраняет его в `s3files` и логирует событие в аудите. Клиентам возвращается только SHA-256 хэш, который затем нужно передавать в параметре `key` метода `s3URL`/API для публичного доступа.【F:src/api/file/share.php†L7-L16】
- `/api/file/removeShare.php` очищает ключ и фиксирует действие в аудите, тем самым немедленно аннулируя публичные ссылки.【F:src/api/file/removeShare.php†L7-L13】

## Конфигурация AWS S3 и CloudFront

Все параметры настраиваются через Config:

| Ключ | Назначение |
| --- | --- |
| `AWS_S3_KEY`, `AWS_S3_SECRET` | Ключ и секрет доступа сервера к S3.【F:src/common/libs/Config/configStructureArray.php†L610-L652】 |
| `AWS_S3_BUCKET` | Имя бакета хранения файлов.【F:src/common/libs/Config/configStructureArray.php†L654-L674】 |
| `AWS_S3_BROWSER_ENDPOINT`, `AWS_S3_SERVER_ENDPOINT` | Endpoints для браузерных загрузок и серверной работы соответственно (можно использовать эмуляторы или кастомные URL).【F:src/common/libs/Config/configStructureArray.php†L676-L717】 |
| `AWS_S3_ENDPOINT_PATHSTYLE` | Включает path-style запросы (обычно `Disabled`).【F:src/common/libs/Config/configStructureArray.php†L718-L738】 |
| `AWS_S3_REGION` | Регион бакета.【F:src/common/libs/Config/configStructureArray.php†L740-L760】 |
| `AWS_CLOUDFRONT_ENABLED` | Переключатель использования CloudFront и подписанных ссылок.【F:src/common/libs/Config/configStructureArray.php†L761-L781】 |
| `AWS_CLOUDFRONT_PRIVATEKEY`, `AWS_CLOUDFRONT_KEYPAIRID` | Ключ и Key Pair ID для подписи CloudFront-ссылок.【F:src/common/libs/Config/configStructureArray.php†L783-L825】 |
| `AWS_CLOUDFRONT_ENDPOINT` | CDN-адрес, который будет использоваться в выдаваемых ссылках.【F:src/common/libs/Config/configStructureArray.php†L827-L846】 |

### Интеграция с CloudFront

При включённом `AWS_CLOUDFRONT_ENABLED` приложение использует SDK CloudFront для подписи URL, конвертируя приватный ключ в требуемый формат и добавляя параметры контента для скачивания/просмотра. При выключении ссылки формируются через `S3Client::createPresignedRequest` с аналогичными настройками заголовков.【F:src/common/libs/bCMS/bCMS.php†L185-L226】

## Ограничения размеров и форматирование

- `s3Passthrough` ограничивает прямую выдачу через Data URI 10 МБ, чтобы предотвратить перегрузку памяти и ускорить генерацию PDF/картинок.【F:src/common/libs/bCMS/bCMS.php†L123-L142】
- `formatSize` в `bCMS` поможет отображать объём хранилища пользователю в понятном виде (байты → KB/MB/GB).【F:src/common/libs/bCMS/bCMS.php†L43-L59】

## Документация API `/src/api/file/index.php`

### Назначение

Возвращает временную ссылку на файл или перенаправляет на неё, обрабатывая флаги безопасности и share-ключи через `bCMS->s3URL`.

### Параметры запроса

| Параметр | Тип | Описание |
| --- | --- | --- |
| `f` | integer | Обязательный идентификатор файла в `s3files`.|
| `d` | boolean | При наличии принудительно скачивает файл (иначе открывает inline).|
| `r` | boolean | При наличии выполняет HTTP-редирект на полученный URL.|
| `e` | string | Человеко-понятное значение срока действия (например, `+5 minutes`).|
| `key` | string | Хэш share-ключа для публичного доступа (если используется).|

Логика: endpoint вызывает `s3URL` с переданными параметрами и возвращает JSON (`{ result: true, url }`) либо делает редирект, если установлен `r`. При ошибках (`файл не найден/нет доступа`) возвращается `{ result: false, message }`.【F:src/api/file/index.php†L1-L94】

### Примеры использования

```bash
# Получить presigned URL (JSON)
curl -X POST \
  -F "f=123" \
  -F "e=+5 minutes" \
  https://example.com/api/file/index.php

# Получить прямой редирект на файл
curl -X POST \
  -F "f=123" \
  -F "d=1" \
  -F "r=1" \
  https://example.com/api/file/index.php -I

# Открыть публичную ссылку по share-ключу
curl -X POST \
  -F "f=123" \
  -F "key=<sha256-share-hash>" \
  https://example.com/api/file/index.php
```

### Рекомендации по хранению ключей и URL

- Не сохраняйте выданные presigned URL в базе — они истекают согласно `e` и становятся недействительными.
- Share-ключи храните только в виде хэша, как это делает API, чтобы исключить компрометацию. Клиентам достаточно SHA-256 значения из ответа `/file/share.php`.【F:src/api/file/share.php†L7-L16】

## Best practices по эксплуатации

1. **Сроки хранения и автоматическое удаление.** Настраивайте `s3files_meta_deleteOn`, чтобы заранее ставить даты очистки. Система автоматически блокирует выдачу просроченных файлов, помогая выполнять политики хранения и GDPR/ГОСТ требования.【F:src/common/libs/bCMS/bCMS.php†L155-L160】
2. **Регулярная очистка больших объектов.** Контролируйте размер через `s3files_meta_size` (например, используя отчёты на базе `s3StorageUsed`) и избегайте хранения файлов >10 МБ, если они используются в Data URI/пасстру функциях.【F:src/common/libs/bCMS/bCMS.php†L85-L101】【F:src/common/libs/bCMS/bCMS.php†L123-L140】
3. **Аудит доступа и действий.** Используйте встроенный `auditLog` и следите за событиями `analyticsEvents`, которые автоматически пишутся при каждом защищённом запросе. Это облегчает аудит доступа к файлам и выявление нарушений.【F:src/common/libs/bCMS/bCMS.php†L68-L83】【F:src/common/headSecure.php†L26-L35】
4. **Переоформление публичных ссылок.** Периодически регенерируйте share-ключи через `/file/share.php` и удаляйте их при завершении работ, чтобы исключить бесконтрольный внешний доступ.【F:src/api/file/share.php†L7-L16】【F:src/api/file/removeShare.php†L7-L13】
5. **Минимизация времени жизни ссылок.** Ограничивайте `e` несколькими минутами для защищённых типов и предоставляйте более длительные значения только для статичных публичных ресурсов, чтобы сократить окно атаки.【F:src/common/libs/bCMS/bCMS.php†L162-L163】
6. **Регулярные ревизии конфигурации.** Проверяйте настройки S3/CloudFront (ключи, endpoint, режимы Path-Style) и обновляйте их при ротации секретов или изменении инфраструктуры, чтобы избежать недоступности или утечек.【F:src/common/libs/Config/configStructureArray.php†L610-L846】
7. **Логирование операций обмена.** Поскольку share/unshare действия автоматически фиксируются через `auditLog`, планируйте периодический обзор этих записей, чтобы убедиться, что публичные ссылки используются по назначению.【F:src/api/file/share.php†L7-L16】【F:src/api/file/removeShare.php†L7-L13】

Следуя данным рекомендациям, можно обеспечить безопасное и управляемое хранение файлов в AdamRMS, сохраняя совместимость с AWS S3, CloudFront и потенциальными S3-совместимыми сервисами.

## Типовой пользовательский сценарий

1. **Загрузка и категоризация.** Пользователь загружает файл через UI или API, после чего запись появляется в таблице `s3files` с атрибутами типа, размера и флагами безопасности. Тип файла определяет значения `secure` и `requireInstance`, поэтому сразу же задаёт требования к авторизации и видимости для остальных шагов процесса.【F:src/common/libs/bCMS/bCMS.php†L166-L183】
2. **Получение ссылки сотрудником инстанции.** Авторизованный член инстанции запрашивает доступ к файлу (например, в карточке проекта). Приложение вызывает `bCMS->s3URL`, проверяет принадлежность пользователя к инстанции, истечение срока удаления и формирует временный URL с учётом флага `forceDownload` или срока действия `expire`. Ссылка отображается в интерфейсе или передаётся по API как часть ответа контроллера/эндпоинта.【F:src/common/libs/bCMS/bCMS.php†L155-L226】【F:src/api/file/index.php†L1-L94】
3. **Публичный обмен (по необходимости).** Если требуется поделиться файлом с внешним контрагентом, пользователь с соответствующими правами генерирует share-ключ через `/api/file/share.php`. Клиент получает SHA-256 хэш, отправляет его внешнему адресату, а тот указывает его в параметре `key` при обращении к `/api/file/index.php`, получая временную ссылку без необходимости аккаунта в системе.【F:src/api/file/share.php†L7-L16】【F:src/api/file/index.php†L1-L94】
4. **Очистка и аудит.** По завершении задачи владелец файла либо удаляет share-ключ через `/api/file/removeShare.php`, либо устанавливает `deleteOn`, чтобы файл автоматически перестал выдаваться и был удалён при следующей уборке. Все действия фиксируются в аудите, что позволяет отследить историю доступа и убедиться, что политика хранения соблюдается.【F:src/common/libs/bCMS/bCMS.php†L125-L160】【F:src/api/file/removeShare.php†L7-L13】

Такой сценарий обеспечивает контролируемый доступ к данным: внутренние пользователи работают с файлами в пределах своих инстанций, а внешние получают ограниченные по времени ссылки, чьё создание и отзыв прозрачно логируются.

## Как это работает простыми словами

1. **Мы складываем файлы в «облако».** Когда вы загружаете документ или картинку, система записывает его в таблицу `s3files` и отправляет в бакет S3. Мы помечаем, кто может его видеть, и ставим дату, когда файл нужно удалить.
2. **Каждому файлу выдаётся одноразовая ссылка.** Когда кто-то просит файл, сервер проверяет: этот человек вошёл в систему? относится ли к нужной инстанции? не просрочен ли файл? Если всё хорошо, мы создаём короткую ссылку, которая живёт всего несколько минут.
3. **Хотите поделиться снаружи — создайте ключ.** Пользователь с правами делает «ключ» через `/file/share.php`. Это как пароль: получатель вставляет его в запрос и получает ту же одноразовую ссылку, даже без аккаунта. Ключ можно удалить в любой момент.
4. **Регулярно убираем и проверяем.** По расписанию мы смотрим на отметку удаления и чистим старые файлы из S3. Все действия — кто открыл, кто поделился, кто удалил — записываются в журнал, чтобы можно было проверить историю.

Так файл хранится безопасно, ссылки живут недолго, а вы всегда знаете, кто им пользовался.
