# Global Search

## Назначение и состав
Глобальный поиск объединяет несколько доменных провайдеров (`SearchCMS`, `SearchProjects`, `SearchClients`, `SearchLocations`, `SearchUsers`) и выполняет их последовательно, возвращая единый набор результатов. Каждый провайдер создаётся при инициализации `Search` и управляется базовым классом `BaseSearch`, что упрощает повторное использование и кеширование данных экземпляра.【F:src/common/libs/Search/Search.php†L3-L41】【F:src/common/libs/Search/BaseSearch.php†L17-L142】

## HTTP-параметры запроса
Страница `/search.php` принимает три параметра, которые передаются через `$_GET` и подставляются в `Search::search()`:
- `term` — обязательная строка для поиска. Пустая строка предотвращает запуск поиска.【F:src/search.php†L8-L12】【F:src/search.php†L58-L62】
- `limit` — целое число, ограничивающее размер страницы. По умолчанию 25 на UI, а в API-слое базового класса — 20, если параметр не передан.【F:src/search.php†L10-L11】【F:src/common/libs/Search/BaseSearch.php†L31-L74】
- `offset` — целое число, определяющее смещение страницы и позволяющее реализовать пагинацию.【F:src/search.php†L9-L11】【F:src/common/libs/Search/BaseSearch.php†L31-L74】

## Twig-функции представления
`search.php` регистрирует две пользовательские Twig-функции перед рендерингом шаблона:
- `generate_result_url(result)` — строит внутренние ссылки на проект, локацию, клиента, CMS-страницу или пользователя в зависимости от `type` элемента результата. Если тип неизвестен, возвращает `null`, и заголовок выводится без гиперссылки.【F:src/search.php†L15-L34】
- `generate_result_tag(result)` — выбирает цвет и подпись бейджа, отображаемого рядом с заголовком результата, также опираясь на `type`. Неизвестные типы пропускаются.【F:src/search.php†L36-L55】

## Формат результатов и провайдеры
Все провайдеры наследуются от `BaseSearch::load()` и обязаны возвращать массив объектов со структурой:
```php
[
    'type' => string,
    'searchable' => string[],
    'title' => string,
    'except' => ?string,
    'data' => array
]
```
`BaseSearch::search()` использует Fuse.js для нечёткого поиска, отбрасывает поле `searchable` перед отдачей ответа и включает в итоговые метаданные `total`, `offset`, `limit` и `speed` выполнения.【F:src/common/libs/Search/BaseSearch.php†L36-L90】 Ниже приведены особенности каждого провайдера:

- **SearchCMS** — индексирует опубликованные CMS-страницы текущего инстанса, рендерит свежую версию через Twig, преобразует HTML в текст и сохраняет сокращённый анонс. Доступ фильтруется по видимости групп.【F:src/common/libs/Search/SearchCMS.php†L9-L80】
- **SearchProjects** — возвращает проекты инстанса с разрешением `PROJECTS:VIEW`, включает связанные клиента, менеджера и важные даты, которые также попадают в массив `searchable` и в сниппет описания.【F:src/common/libs/Search/SearchProjects.php†L11-L65】
- **SearchClients** — индексирует клиентов инстанса, доступных по разрешению `CLIENTS:VIEW`, и добавляет контактные поля в поисковый массив.【F:src/common/libs/Search/SearchClients.php†L11-L40】
- **SearchLocations** — загружает активные локации с привязкой к клиенту и заметками, требуя `LOCATIONS:VIEW`. Заметки обрезаются до 200 символов для превью.【F:src/common/libs/Search/SearchLocations.php†L11-L40】
- **SearchUsers** — отображает пользователей, если есть разрешение `BUSINESS:USERS:VIEW:INDIVIDUAL_USER` или серверное `USERS:EDIT`. Для неадминистраторов дополнительно фильтрует по текущему инстансу и активным участникам.【F:src/common/libs/Search/SearchUsers.php†L11-L43】

## Советы по использованию
- Используйте несколько ключевых слов или части имени — Fuse.js учитывает близость и выводит наиболее релевантные совпадения даже при неточных вводах.【F:src/common/libs/Search/BaseSearch.php†L36-L74】
- Комбинируйте значения `term`, `limit` и `offset`, чтобы быстро пролистывать большие наборы результатов или строить постраничную навигацию в интеграциях.
- Для точных фильтров (например, поиск конкретного клиента) включайте уникальные атрибуты, такие как телефон или адрес, которые добавлены в `searchable` соответствующего провайдера.【F:src/common/libs/Search/SearchClients.php†L27-L35】【F:src/common/libs/Search/SearchLocations.php†L28-L35】
- При поиске проектов добавляйте даты или имя менеджера, так как они также индексируются и ускоряют уточнение выдачи.【F:src/common/libs/Search/SearchProjects.php†L27-L61】

## Типовой пользовательский сценарий
1. Пользователь открывает глобальную строку поиска (иконка лупы в верхнем меню) и вводит первые ключевые слова запроса.
2. Клиентская часть отправляет GET-запрос к `/search.php` с параметрами `term`, `limit` и `offset`, установленными по умолчанию (например, `limit=25`, `offset=0`).
3. На сервере инициализируется `Search`, загружаются активные провайдеры (`SearchCMS`, `SearchProjects`, `SearchClients`, `SearchLocations`, `SearchUsers`), после чего `BaseSearch::search()` объединяет и ранжирует результаты.
4. Ответ возвращается в формате JSON; фронтенд преобразует его в блоки карточек, используя Twig-функции `generate_result_url` и `generate_result_tag` для ссылок и бейджей.
5. Пользователь просматривает первые результаты и, при необходимости, уточняет запрос или использует пагинацию (изменение `offset`) для перехода на следующие страницы.
6. Клик по карточке перенаправляет на соответствующую сущность (проект, клиента, локацию и т. д.), где пользователь продолжает работу, например обновляет данные или открывает связанные документы.

## Расширение новыми провайдерами
1. Создайте класс `SearchSomething` в `src/common/libs/Search/`, унаследованный от `BaseSearch`, и реализуйте `load()` с требуемыми правами доступа и структурой элемента результата.
2. Подготовьте данные с полем `searchable`, включив в него ключевые строки, по которым ожидается поиск.
3. Зарегистрируйте провайдер в конструкторе `Search`, добавив его в массив `$this->providers` для объединения выдачи.【F:src/common/libs/Search/Search.php†L15-L41】
4. При необходимости расширьте Twig-функции, чтобы новые типы получали корректные ссылки и бейджи на UI.【F:src/search.php†L18-L55】

## Диагностика и оптимизация
- **Пустая выдача**: убедитесь, что пользователь авторизован и имеет права на соответствующий домен, иначе провайдер вернёт пустой массив (см. проверки разрешений в каждом `load()`).
- **Неполные данные**: вызовите `BaseSearch::refresh()` или создайте новый экземпляр `Search`, чтобы сбросить кеш и подтянуть актуальные записи после изменений.【F:src/common/libs/Search/BaseSearch.php†L98-L114】
- **Низкая производительность**: уменьшите `limit`, чтобы сократить обрабатываемый объём, или добавьте специфичные ключевые слова — Fuse.js сортирует результаты, но большое количество записей может увеличивать время ответа, что отражается в поле `speed`.【F:src/common/libs/Search/BaseSearch.php†L36-L74】
- **Добавление новых полей**: расширяйте массив `searchable` провайдера только необходимыми строками, чтобы поддерживать баланс между релевантностью и скоростью.
- **Логирование**: для отладки используйте измерение `speed` в ответе и внешние профилировщики MySQL, чтобы выявить узкие места на этапе загрузки данных до запуска Fuse.js.

## Как это работает простыми словами
1. **Вводите запрос** — в верхней строке пишете слово или фразу, например «камера Sony» или «Анна Иванова».
2. **Поиск идёт по разделам** — система автоматически проверяет сразу несколько списков: страницы CMS, проекты, клиентов, локации и пользователей. Каждый раздел хранит свои ключевые слова, чтобы легче найти нужную запись.
3. **Результаты сортируются по близости** — чем точнее совпадение с вашим запросом, тем выше карточка окажется в выдаче. Даже если вы ошиблись в паре букв, алгоритм постарается подобрать похожие варианты.
4. **Карточки показывают контекст** — возле заголовка будет цветной бейдж с типом записи и короткое описание, чтобы сразу понять, что за сущность нашлась.
5. **Открываете нужный объект** — нажимаете на карточку и переходите на страницу проекта, клиента или пользователя, где можно продолжить работу.
6. **Уточняете при необходимости** — если результатов много, меняете запрос, увеличиваете или уменьшаете лимит, листаете дальше через пагинацию. Это не требует перезагрузки страницы: интерфейс отправляет новый запрос и обновляет список.
