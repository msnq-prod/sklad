# Администрирование инстанса

## Обзор и права доступа
- Раздел **Users in Business** доступен из `/instances/users.php` и требует права `BUSINESS:USERS:VIEW:LIST`; страница подключается через `headSecure.php`, поэтому переход возможен только после аутентификации в выбранном инстансе.【F:src/instances/users.php†L4-L18】
- Конфигурационные страницы (статусы активов, баркоды, счета и логотип) требуют права просмотра `BUSINESS:BUSINESS_SETTINGS:VIEW`, а любые изменения — права `BUSINESS:BUSINESS_SETTINGS:EDIT`. Навигационные вкладки связывают эти настройки с проектными типами/статусами и другими административными разделами.【F:src/instances/configuration/asset-status.php†L5-L14】【F:src/instances/configuration/instances_configuration_asset_status.twig†L10-L61】【F:src/instances/configuration/instances_configuration_barcodes.twig†L15-L59】【F:src/instances/configuration/instances_configuration_invoices.twig†L8-L43】【F:src/instances/configuration/instances_configuration_logo.twig†L7-L64】

## Навигация по управлению пользователями
1. Воспользуйтесь ссылкой «Назад к настройкам» и вкладкой **Пользователи** в верхнем меню, чтобы переключаться между пользователями, правами, кодами приглашений и доверенными доменами инстанса.【F:src/instances/instances_users.twig†L13-L27】
2. Таблица пользователей построена на DataTables и поддерживает сортировку/поиск по ключевым столбцам (имя пользователя, почта). Навигация по строкам разрешает переход к карточкам пользователей при наличии права `BUSINESS:USERS:VIEW:INDIVIDUAL_USER`.【F:src/instances/instances_users.twig†L56-L104】
3. Модальные окна открываются из действий строки, позволяя менять подпись роли и группу ролей (позицию) для выбранного участника; списки ролей подгружаются из `instancePositions` и сортируются по рангу.【F:src/instances/users.php†L24-L26】【F:src/instances/instances_users.twig†L130-L165】

## Просмотр и контроль лимитов capacity
1. При загрузке страницы рассчитывается лимит пользователей инстанса (`instances_userLimit`) и фактическое использование с учётом неархивированных записей. Если квота исчерпана, пользователю показывается предупреждение и ссылка на биллинг; добавление новых пользователей блокируется.【F:src/instances/users.php†L28-L41】【F:src/instances/instances_users.twig†L30-L45】
2. В остальных случаях включается форма добавления: Select2 ищет существующих аккаунтов по email через `/api/instances/searchUser.php`, после чего мастер запрашивает группу ролей и отображаемое имя роли перед отправкой в `instances/addUser.php`.【F:src/instances/instances_users.twig†L234-L305】

## Сценарии управления пользователями
### Типовой сценарий работы с пользователями
1. Перейдите в `/instances/users.php` с правом `BUSINESS:USERS:VIEW:LIST` — контроллер загружает пользователей, сортирует их по статусу и ролям и передаёт список в шаблон страницы.【F:src/instances/users.php†L2-L26】
2. Если у вас есть право приглашать новых участников, карточка **Добавить пользователей** покажет доступный лимит и форму Select2; при исчерпании квоты блок вывода сменится предупреждением и ссылкой на биллинг.【F:src/instances/users.php†L28-L41】【F:src/instances/instances_users.twig†L30-L47】
3. Таблица DataTables поддерживает поиск и сортировку по имени, email и ролям, а также отображает бейджи Suspended/Archived, помогая быстро отделить активных участников.【F:src/instances/instances_users.twig†L57-L126】【F:src/instances/instances_users.twig†L175-L189】
4. Для изменения данных используйте кнопки в строке: карандаш открывает модальное окно с полями роли и группы, архив и удаление запускают подтверждения Bootbox и Ajax-запросы, после которых страница перезагружается.【F:src/instances/instances_users.twig†L100-L232】
5. Ежедневная проверка списка включает фильтрацию по поиску, проверку статуса capacity и оперативное редактирование ролей прямо из таблицы, не покидая страницу управления пользователями.【F:src/instances/instances_users.twig†L30-L231】

### Добавление участников
1. Убедитесь, что у вас есть право `BUSINESS:USERS:CREATE:ADD_USER_BY_EMAIL` и свободный capacity.
2. Найдите адреса email через Select2 и нажмите **Добавить в компанию**.
3. Выберите группу ролей (instance position) и название роли в появившихся диалогах. После подтверждения запрос отправляется на `instances/addUser.php`, а таблица обновляется после перезагрузки.【F:src/instances/instances_users.twig†L30-L307】

### Изменение ролей и групп
1. Нажмите кнопку карандаша в строке пользователя (требуется `BUSINESS:USERS:EDIT:CHANGE_ROLE`).
2. В модальном окне обновите поле **Роль** и/или выберите новую **Группу ролей** из списка позиций.
3. Сохраните изменения — запрос `instances/editUser.php` применит обновления и обновит страницу.【F:src/instances/instances_users.twig†L100-L165】【F:src/instances/instances_users.twig†L225-L231】

### Архивирование и восстановление
1. Кнопка архива доступна при праве `BUSINESS:USERS:EDIT:ARCHIVE`. Система подтверждает действие через Bootbox и вызывает `instances/archiveUser.php` с нужным `userid`.
2. Архивированные записи помечаются бэйджем **Archived**. Повторное нажатие кнопки (зелёная) снимает архивацию и вновь активирует участника.【F:src/instances/instances_users.twig†L89-L114】【F:src/instances/instances_users.twig†L202-L222】

### Удаление из инстанса
1. Кнопка корзины доступна при праве `BUSINESS:USERS:DELETE:REMOVE_FORM_BUSINESS`.
2. После подтверждения вызывается `instances/removeUser.php`, и пользователь удаляется из инстанса; предупреждение напоминает, что удаление последнего участника лишает доступов ко всем проектам инстанса.【F:src/instances/instances_users.twig†L115-L201】

## Работа с архивами и связанными представлениями
- Таблица помечает приостановленные аккаунты (Suspended) и архивы, упрощая фильтрацию активных пользователей в DataTables. Используйте сортировку по столбцу роли или поисковое поле, чтобы быстро находить нужные записи.【F:src/instances/instances_users.twig†L56-L126】
- Модальные окна наследуют текущую позицию пользователя, поэтому архивация/удаление не влияет на историю ролей, пока запись не будет полностью удалена из инстанса.【F:src/instances/users.php†L14-L41】【F:src/instances/instances_users.twig†L130-L231】

## Конфигурация статусов активов и других настроек
### Статусы активов
1. Перейдите в `/instances/configuration/asset-status.php` через навигацию настроек.
2. Список статусов загружается из `assetsAssignmentsStatus` с сортировкой по `assetsAssignmentsStatus_order`. При праве редактирования можно перетаскивать строки для изменения порядка, создавать новые статусы через Bootbox или удалять существующие (все действия вызывают соответствующие API `instances/assetAssignmentStatus/*`).【F:src/instances/configuration/asset-status.php†L5-L14】【F:src/instances/configuration/instances_configuration_asset_status.twig†L30-L115】

### Баркоды и цвета кабелей
- Страница баркодов отображает и редактирует JSON-словарь `instances_cableColours`. Пользователи с правом редактирования могут добавлять строки, выбирать цвета через Spectrum и отправлять изменения в `instances/editInstance.php`. Цвет текста автоматически инвертируется для контраста.【F:src/instances/configuration/instances_configuration_barcodes.twig†L27-L102】

### Футеры котировок и счетов
- Раздел счетов предоставляет два текстовых поля (footer для котировок и инвойсов). Кнопка **Save** отправляет обновлённые тексты в `instances/editInstance.php`; просмотр доступен всем с правом `BUSINESS:BUSINESS_SETTINGS:VIEW`, редактирование — только с правом `BUSINESS:BUSINESS_SETTINGS:EDIT`.【F:src/instances/configuration/instances_configuration_invoices.twig†L24-L59】

### Логотипы и email-хедеры
- При включённом файловом хранилище страница логотипа позволяет загрузить публичный логотип и заголовок писем через Uppy. После успешной загрузки `instances/editInstance.php` сохраняет ID файла; система предупреждает, что оба файла общедоступны. Если файлы отключены, отображается уведомление о недоступности загрузок.【F:src/instances/configuration/instances_configuration_logo.twig†L20-L89】

## Best practices для многоинстансной эксплуатации
- Используйте вкладку «Назад к настройкам» в каждом разделе, чтобы быстро переключаться между управлением пользователями, проектами и активами без потери контекста — меню построено на единых навигационных ссылках между разделами (`projectTypes`, `projectStatuses`, `customCategories`).【F:src/instances/instances_users.twig†L13-L27】【F:src/instances/configuration/instances_configuration_asset_status.twig†L10-L21】【F:src/instances/configuration/instances_configuration_barcodes.twig†L13-L20】
- Разграничивайте права доступа: предоставляйте `BUSINESS:USERS:VIEW:LIST` менеджерам проектов, а `BUSINESS:BUSINESS_SETTINGS:EDIT` — только администраторам, чтобы минимизировать риски при изменении глобальных настроек.
- Отслеживайте лимиты capacity до массовых приглашений; при достижении порога заранее планируйте апгрейд тарифа, чтобы избегать отказов при добавлении участников.【F:src/instances/users.php†L28-L41】
- Регулярно архивируйте неактивных пользователей вместо полного удаления, чтобы сохранять историю взаимодействий и распределения ролей для проверок и аудита.【F:src/instances/instances_users.twig†L86-L222】

## Связанные документы
- [Управление активами](./asset-administration.md)
- [Управление проектами](./project-administration.md)

## Как это работает — объяснение простыми словами
1. **Страница пользователей**. Представьте таблицу сотрудников компании. Вы заходите на `/instances/users.php`, видите всех участников и можете нажать на значки рядом с именем, чтобы изменить роль, архивировать или удалить человека. Если рядом с блоком добавления пользователей появилось красное предупреждение, значит лимит аккаунтов исчерпан и сначала нужно повысить тариф.【F:src/instances/users.php†L28-L41】【F:src/instances/instances_users.twig†L30-L231】
2. **Добавление людей**. Нажимаете кнопку добавления, вписываете email, выбираете подходящую группу и роль. Система проверит, есть ли место, и после подтверждения новый участник появится в таблице. Всё происходит без перехода на другие страницы — форма сама отправляет запрос и обновляет список.【F:src/instances/instances_users.twig†L234-L307】
3. **Архивация и удаление**. Если сотрудник временно не работает, нажмите кнопку «Архив». Запись останется в системе и её можно вернуть. Если нужно полностью убрать доступ, используйте значок корзины — после подтверждения человек исчезнет из таблицы и потеряет доступ к проектам инстанса.【F:src/instances/instances_users.twig†L86-L222】
4. **Настройки инстанса**. Во вкладках рядом со страницей пользователей находятся конфигурации: статусы активов, цвета кабелей, тексты для счетов и загрузка логотипов. Каждая вкладка — это простой список или форма. Перетаскиваете строки, заполняете текст или загружаете файл и нажимаете «Сохранить», после чего изменения применяются сразу к всему инстансу.【F:src/instances/configuration/instances_configuration_asset_status.twig†L30-L115】【F:src/instances/configuration/instances_configuration_barcodes.twig†L27-L102】【F:src/instances/configuration/instances_configuration_invoices.twig†L24-L59】【F:src/instances/configuration/instances_configuration_logo.twig†L20-L89】
5. **Лучшие практики**. Чтобы не запутаться, договоритесь в команде, кому нужны права на просмотр, а кому — на редактирование настроек. Регулярно проверяйте лимиты и архивируйте тех, кто больше не работает. Так вы сохраните порядок и историю, а доступы будут в безопасности.【F:src/instances/users.php†L28-L41】【F:src/instances/instances_users.twig†L56-L231】
