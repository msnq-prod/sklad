# Операции с заявками обслуживания

## Обзор модуля
Страница `maintenance/index.php` предоставляет списковый интерфейс для заявок обслуживания текущего инстанса и управляет доступом через проверку разрешения `MAINTENANCE_JOBS:VIEW`. В карточке заявки (`maintenance/job.php`) отображаются подробности, статусы, связанные пользователи, оборудование, переписка и аудит изменений. Пользователи без прав видят страницу 404, что предотвращает просмотр данных посторонними.

## Фильтрация, статусы и сортировка
- **Фильтрация по инстансу и удалённости.** Список заявок всегда ограничивается текущим инстансом и исключает удалённые записи (`maintenanceJobs_deleted = 0`).【F:src/maintenance/index.php†L13-L17】
- **Отображение завершённых заявок.** Флаг `showCompleted` определяется параметром `?completed`. При его отсутствии выводятся только статусы, помеченные как «показывать в основном списке», а заявки без статуса также остаются в выборке. При включённом флаге выводятся только статусы, скрытые из основного списка (обычно завершённые/архивные).【F:src/maintenance/index.php†L8-L18】
- **Связанные пользователи.** Для каждой заявки выполняются соединения с создателем и назначенным исполнителем, чтобы вывести их профили в таблице и карточке.【F:src/maintenance/index.php†L18-L24】【F:src/maintenance/job.php†L13-L16】
- **Порядок сортировки.** Список отсортирован по порядку статуса, приоритету, сроку и дате создания. Это гарантирует, что критичные и ближайшие по сроку задачи отображаются первыми даже внутри одинаковых статусов.【F:src/maintenance/index.php†L20-L23】
- **Перечень статусов.** Детальная страница получает полный набор статусов, доступных инстансу, отсортированный по порядку и названию. Текущий статус сопоставляется для акцентирования заголовка и управления переходами.【F:src/maintenance/job.php†L18-L30】【F:src/maintenance/job.twig†L75-L88】

## Роли участников и история изменений
- **Создатель заявки.** В карточке выводятся ФИО и e-mail автора, с переходом на профиль при наличии прав на просмотр пользователей.【F:src/maintenance/job.php†L13-L16】【F:src/maintenance/job.twig†L87-L99】
- **Назначенный исполнитель.** Если у пользователя есть право редактировать назначение, отображается выпадающий список с возможными менеджерами. В остальных случаях показывается только текущий исполнитель. Это предотвращает несанкционированное переназначение задач.【F:src/maintenance/job.php†L33-L45】【F:src/maintenance/job.twig†L101-L118】
- **Наблюдатели (tagged).** Система загружает пользователей, отмеченных для уведомлений, и позволяет редактировать их при наличии разрешения `MAINTENANCE_JOBS:EDIT:USERS_TAGGED_IN_JOB`. Это упрощает рассылку обновлений и совместную работу.【F:src/maintenance/job.php†L47-L61】【F:src/maintenance/job.twig†L132-L139】
- **История и аудит.** Карточка заявки строит таймлайн по аудит-логам: группировка по дате, иконки по типу события, отображение автора и описания изменений. Это позволяет отследить создание, правки, архивирование и быстрые комментарии.【F:src/maintenance/job.php†L64-L71】【F:src/maintenance/job.twig†L330-L386】
- **Обсуждение.** Сообщения с вложениями подтягиваются из `maintenanceJobsMessages` и выводятся в формате чата с поддержкой изображений и файлов. Это канал для оперативной коммуникации и фиксации решений.【F:src/maintenance/job.php†L90-L98】【F:src/maintenance/job.twig†L216-L324】

## Основные сценарии работы
1. **Создание заявки.** Пользователь с правом `MAINTENANCE_JOBS:VIEW` открывает «Новая задача», заполняет заголовок, описание, приоритет, срок и назначенного исполнителя. После сохранения заявка появляется в основном списке, а создатель становится владельцем и автоматически фиксируется в истории.【F:src/maintenance/index.php†L18-L24】【F:src/maintenance/job.twig†L75-L115】
2. **Перевод по статусам.** Статусы выбираются из справочника инстанса. Переключение доступно пользователям с правом `MAINTENANCE_JOBS:EDIT:STATUS`. Порядок сортировки и флаг `maintenanceJobsStatuses_showJobInMainList` определяют, когда заявка исчезает из основного списка и попадает в раздел завершённых.【F:src/maintenance/index.php†L8-L23】【F:src/maintenance/job.php†L18-L30】
3. **Завершение и контроль сроков.** При переводе в финальный статус (обычно скрытый из основного списка) заявка остаётся доступной через переключатель «Показать выполненные». Приоритет и срок помогают определить просроченные задачи, поэтому важно обновлять их при каждом изменении статуса.【F:src/maintenance/index.php†L8-L23】【F:src/maintenance/job.twig†L119-L131】
4. **Работа с архивом.** Архивные действия фиксируются в аудит-логе с иконкой запрета. Даже после архивирования можно просмотреть полную историю, сообщения и вложения, что упрощает анализ инцидентов и повторное открытие при необходимости.【F:src/maintenance/job.php†L64-L71】【F:src/maintenance/job.twig†L330-L386】

### Типовой пользовательский сценарий
1. **Диспетчер получает запрос.** Автор формулирует задачу, проверяет, есть ли привязка к активу или проекту, и регистрирует заявку со сроком и приоритетом, чтобы в списке она появилась в нужном сегменте и попала в отчётность по SLA.【F:src/maintenance/index.php†L18-L23】【F:src/maintenance/job.twig†L140-L215】
2. **Исполнитель принимает работу.** Назначенный пользователь просматривает таймлайн, связанные файлы и комментарии, уточняет детали в чате заявки и при необходимости добавляет наблюдателей или блокирует актив для выдачи в проекты.【F:src/maintenance/job.php†L33-L88】【F:src/maintenance/job.twig†L101-L324】
3. **Команда отслеживает прогресс.** Все участники получают уведомления о статусах и комментариях, а диспетчер проверяет просрочки через сортировку по срокам и приоритетам. При изменении контекста (например, замена оборудования) обновляются связанные активы и статус проекта.【F:src/maintenance/index.php†L20-L23】【F:src/maintenance/job.php†L73-L88】
4. **Закрытие и ретроспектива.** После выполнения работ исполнитель переводит заявку в финальный статус и прикрепляет итоговый отчёт. Диспетчер проверяет, что таймлайн содержит полный набор действий, после чего заявка уходит в архив, оставаясь доступной для поиска и анализа повторяющихся проблем.【F:src/maintenance/job.php†L64-L71】【F:src/maintenance/job.twig†L330-L386】

## Практические рекомендации
- **Контроль SLA.** Используйте приоритет и срок исполнения для мониторинга SLA: сортировка по сроку уже реализована в списке, а цветовые бейджи приоритетов помогают визуально выделять критичные задачи. Рассмотрите добавление автоматических напоминаний перед наступлением срока на основе существующих данных о due date.【F:src/maintenance/index.php†L21-L23】【F:src/maintenance/job.twig†L119-L131】
- **Уведомления.** Поддерживайте актуальный список наблюдателей и назначенного исполнителя — они получают обновления через сообщения и таймлайн. Дополнительно можно интегрировать уведомления с почтой или чатом, используя существующую систему тегов и файловых вложений для отправки отчётов.【F:src/maintenance/job.php†L33-L61】【F:src/maintenance/job.twig†L216-L324】
- **Интеграция с инвентарём и проектами.** Карточка заявки связывается с оборудованием через список assets и позволяет помечать их флагами/блокировками, влияющими на выдачу в проекты. Рекомендуется синхронизировать статусы обслуживания с планированием проектов, чтобы заблокированное оборудование не назначалось на мероприятия, и использовать архив запросов для ретроспектив по конкретным активам.【F:src/maintenance/job.php†L73-L88】【F:src/maintenance/job.twig†L140-L215】


## Простое руководство для пользователей
1. **Откройте список заявок.** Перейдите в раздел обслуживания и выберите нужную заявку или создайте новую кнопкой «Новая задача».
2. **Заполните основные поля.** Напишите короткий заголовок, подробно опишите проблему, выберите приоритет и срок, добавьте файлы и назначьте исполнителя.
3. **Следите за статусом.** После сохранения заявка появится в списке. Обновляйте статус по мере выполнения работ, чтобы коллеги видели прогресс.
4. **Общайтесь в комментариях.** Пишите уточнения и результаты прямо в карточке заявки, добавляйте наблюдателей, если им нужно получать уведомления.
5. **Завершите заявку.** Когда задача выполнена, переведите её в финальный статус, прикрепите итоговый отчёт и убедитесь, что все действия отображены в истории.
6. **Работайте с архивом.** Включите фильтр «Показать выполненные», чтобы найти закрытые заявки, посмотреть детали и при необходимости переоткрыть их.
