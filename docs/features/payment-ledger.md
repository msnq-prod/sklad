# Реестр платежей

Этот документ описывает реализацию страницы `src/ledger.php`, отвечающей за просмотр платежей инстанса, и смежные процессы.

## Фильтры и пагинация

- Доступ разрешён только пользователям с правом `FINANCE:PAYMENTS_LEDGER:VIEW`. При его отсутствии контроллер завершает работу с шаблоном 404. 【F:src/ledger.php†L6-L8】
- Поиск выполняется по строке запроса `q`. Значение очищается методом `$bCMS->sanitizeString()` и используется как подстрока для `payments_reference` и `payments_amount`. 【F:src/ledger.php†L10-L25】
- Пагинация управляется параметром `page`. Значение очищается, а `MysqliDb` ограничивает выдачу 20 строками (`$DBLIB->pageLimit = 20`). Используется `paginate()` для получения текущей страницы и `totalPages` для расчёта границ. 【F:src/ledger.php†L12-L28】
- Запрос сортируется по дате платежа (`payments_date DESC`) и фильтруется по активным, не удалённым платежам типа «входящий платёж» (`payments_type = 1`). Также всегда ограничивается текущим инстансом. 【F:src/ledger.php†L15-L22】

## Форматирование сумм и MoneyPHP

После выборки каждая сумма (`payments_amount`) преобразуется в объект `Money\Money` с использованием валюты инстанса. Валюта берётся из `instances_config_currency` текущего инстанса пользователя. Конверсия выполняется перед передачей данных в шаблон, чтобы Twig мог использовать встроенные фильтры MoneyPHP для форматирования. 【F:src/ledger.php†L31-L34】

## Связь с проектами и клиентами

Для формирования контекста платёж связывается с проектом и клиентом через SQL JOIN:

- `payments.projects_id` → `projects.projects_id`
- `projects.clients_id` → `clients.clients_id`

Такая схема позволяет показывать название проекта и клиента рядом с каждой записью без дополнительных запросов. Все фильтры привязаны к текущему инстансу, поэтому пользователь видит только свои данные. 【F:src/ledger.php†L15-L20】

## Вложения и разрешения

Для каждого платежа вызывается `$bCMS->s3List(14, $payment['payments_id'])`, что возвращает список файлов из хранилища S3, связанных с платёжной записью. Метод `s3List` автоматически фильтрует файлы по типу (код 14 — вложения к платежам), сроку хранения, фактическому наличию в хранилище и сортирует результаты. Доступ к файлам контролируется на уровне `s3URL`: требуется авторизованный пользователь того же инстанса, если тип файла помечен как защищённый. Следовательно, право `FINANCE:PAYMENTS_LEDGER:VIEW` плюс принадлежность к инстансу достаточно, чтобы получать ссылки на вложения. 【F:src/ledger.php†L33-L34】【F:src/common/libs/bCMS/bCMS.php†L93-L140】

## Пользовательские сценарии

1. **Сверка платежей**
   - Пользователь открывает реестр и фильтрует данные по сумме или ссылке на банковский документ.
   - Сопоставляет записи с выпиской, используя даты и суммы.
   - При необходимости скачивает вложенные подтверждающие документы.

2. **Поиск по ссылке (reference)**
   - Вводит часть строки из банковского назначения или внутреннего идентификатора.
   - Поиск возвращает платежи с совпадающими `payments_reference`, упрощая отбор конкретной транзакции.

3. **Экспорт и прикрепление документов**
   - Пользователь скачивает вложенные файлы (PDF, изображения) через интерфейс, используя ссылки, сформированные `s3URL`.
   - Для новых документов создаёт запись в системе, после чего загрузчик помещает файл в S3 с типом 14, и он автоматически появится в списке вложений.

4. **Типовой рабочий день бухгалтера**
   - Утром пользователь открывает реестр, проверяет виджеты уведомлений и устанавливает фильтр по дате «сегодня», чтобы увидеть свежие поступления.
   - Затем вводит в поле поиска номер банковского документа, сверяет сумму и валюту, и отмечает платёж как согласованный во внутренней учётной таблице.
   - В течение дня регулярно переключает фильтры по проектам и клиентам, чтобы убедиться, что все платежи привязаны к корректным сущностям, и при обнаружении расхождений инициирует корректировку в проектной карточке.
   - Перед завершением смены выгружает список платежей за период через экспорт и отправляет ссылку на выгруженный файл менеджеру проекта для подтверждения итогов.

## Контроль качества данных

- Система использует очищенные строки для поиска и проверяет права доступа до выполнения запроса, что предотвращает SQL-инъекции и утечки данных других инстансов. 【F:src/ledger.php†L10-L21】
- Ограничение пагинации снижает риск перегрузки и помогает выявлять дубликаты при поквартальном контроле.
- Рекомендуется регулярно сравнивать суммы с внешними выписками, проверять корректность `payments_type` и актуальность связанного проекта/клиента.

### Типичные ошибки учёта

- Некорректно указанная валюта инстанса приводит к неверному форматированию сумм; при изменении валюты следует пересоздать Money-объекты.
- Ошибочные связи с проектами/клиентами (например, удалённый проект) вызывают пустые поля; необходимо поддерживать целостность внешних ключей.
- Просроченные или удалённые вложения в S3 не отображаются; при аудите следует проверять, что файлы не помечены к удалению раньше времени.
- Отсутствие права `FINANCE:PAYMENTS_LEDGER:VIEW` у пользователей, отвечающих за сверку, блокирует доступ к данным — важно корректно назначать роли.

## Как работает реестр простыми словами

1. **Открываем страницу.** Попадают только те, у кого есть нужное право доступа. Система автоматически выбирает «наш» инстанс, поэтому чужих платежей здесь нет.
2. **Смотрим таблицу.** Каждая строка — это один входящий платёж, уже связанный с конкретным проектом и клиентом. Пользователю не нужно ничего дополнительно связывать вручную.
3. **Фильтруем и ищем.** Вводим часть суммы или номера платежки — реестр оставляет только подходящие строки. Если записей много, переходим между страницами по 20 штук.
4. **Читаем суммы.** Форматирование делает MoneyPHP: система подставляет валюту из настроек инстанса и аккуратно показывает знак, разделители и дробную часть.
5. **Берём документы.** У каждой строки есть список вложений. Клик — и система отдаёт защищённую ссылку из S3, файл скачивается, если мы авторизованы и он ещё хранится.
6. **Экспортируем данные.** Для отчётов скачиваем нужные выгрузки или отдельные вложения и отправляем их коллегам или загружаем в бухгалтерскую систему.
7. **Держим порядок.** Если замечаем, что сумма, проект или клиент не совпадают, сразу исправляем записи или просим коллег обновить информацию, чтобы база оставалась актуальной.
