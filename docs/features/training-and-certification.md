# Обучение и сертификация

## Загрузка модулей и фильтрация
- Страница `src/training/index.php` загружает список модулей с пагинацией (`page`, `pageLimit`) и сортировкой по названию. Для каждой записи подтягиваются активные шаги и сертификаты пользователя.
- Видимость списка ограничивается инстансом и флагом публикации. Пользователи без прав `TRAINING:VIEW:DRAFT_MODULES` видят только опубликованные (`modules_show = 1`) материалы; при наличии права доступен режим черновиков с фильтром `?drafts=1`.
- Дополнительная фильтрация основана на назначенных позициях. Если у пользователя есть позиция и нет прав `TRAINING:EDIT`/`TRAINING:VIEW:USER_PROGRESS_IN_MODULES`, вывод ограничивается группами из `modules_visibleToGroups`. Список позиций загружается заранее, чтобы отобразить расшифровку ID в интерфейсе.

## Режим черновиков и управление доступом
- Черновики позволяют администраторам готовить материалы до публикации. При включённом фильтре отображаются модули с `modules_show = 0`.
- Права `TRAINING:VIEW:DRAFT_MODULES` и `TRAINING:EDIT` контролируют, кто может видеть и редактировать черновики. Пользователи с правом редактирования, но не входящие в целевую группу (`modules_visibleToGroups`), не могут завершать модуль (`canComplete = false`) и видят его только для администрирования.
- Для гибкого управления доступом комбинируйте черновики с ограничениями по позициям: сначала формируйте контент в режиме черновика, затем переводите в публикацию и задавайте список групп, для которых модуль должен быть видимым.

## Отслеживание прогресса, времени и сертификаций
- Прогресс пользователя извлекается из `userModules`: система хранит массив завершённых шагов (`userModules_stepsCompleted`), даты начала и последнего обновления.
- Для каждого модуля загружаются активные шаги (`modulesSteps`) с указанием требуемого времени (`modulesSteps_completionTime`). Складывая время всех шагов, страница отображает суммарную длительность, а также определяет, закрыты ли все шаги.
- Сертификации пользователя собираются из `userModulesCertifications`, включая сведения об утверждающем сотруднике и времени выдачи. Аннулированные (`revoked`) записи исключаются.
- Итоговое состояние модуля определяется полем `canComplete`: пользователи, не относящиеся к целевым группам, могут просматривать материал, но не завершать его самостоятельно, что помогает защищать сертификацию от обхода требований.

## Сценарии использования
### Администраторы
1. Создайте модуль в интерфейсе администрирования (форма `modules`), добавьте шаги с требуемым временем и настройте список видимых позиций.
2. Используйте режим черновика для проверки структуры и контента. Права `TRAINING:VIEW:DRAFT_MODULES` позволяют команде рецензентов просматривать материал до публикации.
3. При необходимости отредактируйте шаги: обновление шага изменит расчёт общего времени и актуализирует прогресс пользователей при следующем посещении.
4. После проверки опубликуйте модуль (`modules_show = 1`) и отслеживайте выдачу сертификатов через журнал `userModulesCertifications`.

### Пользователи
1. Авторизуйтесь и откройте страницу обучения. Список автоматически ограничивается опубликованными курсами вашей организации и позициями, закреплёнными за учётной записью.
2. При необходимости примените фильтр по доступным позициям: если курс нацелен на конкретные группы, интерфейс подскажет, какие из ваших ролей дают доступ к модулю.
3. Ознакомьтесь с карточкой модуля. Она показывает суммарное требуемое время (складывается из шагов), текущий процент выполнения и дату последнего обновления прогресса.
4. Откройте модуль и проходите шаги по порядку. Система отмечает выполненные этапы и фиксирует время, затраченное на каждую задачу, обновляя `userModules_stepsCompleted` и временные отметки.
5. Если модуль требует подтверждения, отправьте запрос администратору: статус «готов к завершению» отображается только когда закрыты все обязательные шаги и вы соответствуете группам доступа.
6. После утверждения администратором сертификат автоматически прикрепляется к модулю и отображается с именем подтверждающего сотрудника и временем выдачи.
7. При повторном прохождении используйте существующий прогресс: уже закрытые шаги подсвечиваются, а повторная сертификация создаёт новую запись, позволяя отслеживать историю обновления навыков.

## Рекомендации по эксплуатации
- **Управление видимостью.** Регулярно актуализируйте `modules_visibleToGroups`, чтобы сотрудники видели только релевантные курсы. Используйте позиции как динамические списки: изменение позиции пользователя автоматически обновит список доступных модулей.
- **Ретеншен знаний.** Планируйте повторные сертификации: настройте напоминания через аналитику или интеграцию уведомлений, а также проверяйте дату последнего обновления прогресса для выявления устаревших навыков.
- **Аудиты обучения.** Используйте журнал сертификаций и аналитические события для подготовки отчётов. Храните черновики как заготовки новых программ и протоколируйте изменения шагов, чтобы восстановить, кто и когда обновил содержание.

## Как это работает простыми словами
1. **Администратор создаёт курс.** Он добавляет шаги, отмечает, сколько времени займёт каждый, и решает, кто увидит курс: все или только сотрудники с нужной должностью.
2. **Курс начинается как черновик.** Пока он не опубликован, его видят только администраторы и рецензенты, которые проверяют текст, шаги и настройки.
3. **Публикация включает доступ.** Когда всё готово, администратор включает курс. Теперь его видят нужные сотрудники, если их должность подходит условиям.
4. **Сотрудник открывает курс.** На карточке видно, сколько времени займёт обучение, сколько уже пройдено и когда в последний раз обновлялся прогресс.
5. **Прохождение шагов.** Каждый выполненный шаг автоматически отмечается. Система складывает время и показывает процент выполнения.
6. **Запрос подтверждения.** Если нужно одобрение, сотрудник нажимает «Готово», и администратор проверяет результат.
7. **Выдача сертификата.** После одобрения в профиле появляется сертификат с именем подтвердившего человека и датой.
8. **Повторное обучение.** При повторном прохождении старые шаги остаются отмеченными, а новая сертификация записывается отдельно, чтобы была видна история.
